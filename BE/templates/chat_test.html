<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebSocket 채팅 테스트</title>
</head>
<body>
    <h1>채팅방 테스트</h1>

    <div>
        <label>채팅방 이름:</label>
        <input id="roomNameInput" type="text" value="testroom">
        <button onclick="connect()">입장</button>
    </div>

    <div id="chat" style="display:none;">
        <h2>채팅</h2>
        <div id="messages" style="border:1px solid #000; height:300px; overflow-y:scroll;"></div>
        <input id="senderInput" type="text" placeholder="보내는 사람" value="user1">
        <input id="messageInput" type="text" placeholder="메시지">
        <button onclick="sendMessage()">보내기</button>
    </div>

    <script>
        let socket = null;

        function connect() {
    // 기존 소켓이 있으면 닫아준다
    if (socket) {
        socket.close();
    }

    const roomName = document.getElementById("roomNameInput").value;
    socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

            socket.onopen = function(e) {
                console.log("WebSocket 연결됨");
                document.getElementById("chat").style.display = "block";
                document.getElementById("messages").innerHTML = "";
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const message = data['message'];
                const sender = data['sender'];

                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML += "<p><strong>" + sender + ":</strong> " + message + "</p>";
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            socket.onclose = function(e) {
                console.log("WebSocket 연결 종료");
            };
        }

        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const senderInput = document.getElementById("senderInput");
            const message = messageInput.value;
            const sender = senderInput.value;

            socket.send(JSON.stringify({
                'message': message,
                'sender': sender
            }));

            messageInput.value = '';
        }
    </script>
</body>
</html>